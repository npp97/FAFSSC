# TODO: to reorganize the simple_soc_model into a function to calibriate the parameters
# 
# Author: junhui.zhang
###############################################################################

require(FME)
require(lhs)
parms_gen_lhs<-function (PARAMETERS, NUMSAMPLES, PMIN, PMAX, ALGORITHM) 
{
	NUMPARAMS <- length(PARAMETERS)
	ALGORITHM <- tolower(ALGORITHM)
	if (ALGORITHM == "optimum") {
		design <- lhs::optimumLHS(NUMSAMPLES, NUMPARAMS, 
				maxSweeps = 2, eps = 0.1)
	}
	else {
		design <- lhs::randomLHS(NUMSAMPLES, NUMPARAMS)
		}
	for (k in 1:NUMSAMPLES) {
		for (l in 1:NUMPARAMS) {
			lhc_max <- PMAX[l]
			lhc_min <- PMIN[l]
			value <- (design[k, l] * (lhc_max - lhc_min)) + lhc_min
			design[k, l] <- value
			}
		}
		colnames(design) <- c(PARAMETERS)
	return(design)
}

ssoc<-function(parms,obs){
	
	
#Leaf area index
	lai<-c(4.84198249992853, 4.83613817181756, 4.83029384370659, 4.82444951559561, 
			4.81860518748464, 4.81276085937367, 4.81045145042843, 4.80913906996582, 
			4.80782668950322, 4.80651430904061, 4.80520192857801, 4.83151546515353, 
			4.87953507940187, 4.92755469365021, 4.97557430789854, 5.02359392214688, 
			5.05318229467146, 5.04699237443817, 5.04080245420488, 5.03461253397159, 
			5.0284226137383, 5.02439834081163, 5.0362554814668, 5.04811262212197, 
			5.05996976277714, 5.07182690343231, 5.08368404408748, 5.14819722911341, 
			5.2185610857361, 5.28892494235879, 5.35928879898147, 5.42965265560416, 
			5.4457251031352, 5.43624865227016, 5.42677220140513, 5.41729575054009, 
			5.40781929967506, 5.40063016482702, 5.39612614008589, 5.39162211534477, 
			5.38711809060364, 5.38261406586251, 5.40433361720003, 5.5090944927866, 
			5.61385536837316, 5.71861624395972, 5.82337711954629, 5.92641448309016, 
			5.94499975654207, 5.96358502999398, 5.9821703034459, 6.00075557689781, 
			6.01934085034972, 5.99667877770039, 5.96370486852574, 5.9307309593511, 
			5.89775705017645, 5.8647831410018, 5.85287550922156, 5.8562227679683, 
			5.85957002671503, 5.86291728546177, 5.8662645442085, 5.8780536207069, 
			5.90485037320826, 5.93164712570961, 5.95844387821096, 5.98524063071231, 
			6.00880807164942, 6.01253831297758, 6.01626855430574, 6.0199987956339, 
			6.02372903696206, 6.02745927829022, 6.02198102415194, 6.01570203127744, 
			6.00942303840295, 6.00314404552846, 5.99686505265396, 5.99182181684497, 
			5.98730819120691, 5.98279456556884, 5.97828093993078, 5.97376731429272, 
			5.97743546836738, 5.98996721713081, 6.00249896589425, 6.01503071465769, 
			6.02756246342112, 6.03741062517951, 6.03962088546199, 6.04183114574447, 
			6.04404140602695, 6.04625166630943, 6.04864211571143, 6.05535710398177, 
			6.06207209225211, 6.06878708052245, 6.07550206879278, 6.08221705706312, 
			6.08199865300283, 6.0802582847724, 6.07851791654198, 6.07677754831155, 
			6.07503718008112, 6.07367910378534, 6.07257588877932, 6.07147267377331, 
			6.07036945876729, 6.06926624376128, 6.06732402568741, 6.06401290787126, 
			6.06070179005511, 6.05739067223895, 6.0540795544228, 6.05087601148508, 
			6.04823723665914, 6.04559846183319, 6.04295968700725, 6.0403209121813, 
			6.03768213735536, 6.03916907406865, 6.04091935407169, 6.04266963407472, 
			6.04441991407776, 6.04617019408079, 6.05121423660263, 6.05753918677067, 
			6.06386413693872, 6.07018908710676, 6.07651403727481, 6.08246153621865, 
			6.0880315839383, 6.09360163165795, 6.0991716793776, 6.10474172709725, 
			6.10714980580479, 6.1014271070526, 6.09570440830042, 6.08998170954824, 
			6.08425901079605, 6.07897545748743, 6.0805718494612, 6.08216824143497, 
			6.08376463340874, 6.08536102538251, 6.08695741735629, 6.08845297077981, 
			6.08992931686044, 6.09140566294106, 6.09288200902168, 6.09435835510231, 
			6.09821173650969, 6.10352201053669, 6.10883228456369, 6.11414255859069, 
			6.11945283261769, 6.12232839787349, 6.12155189997247, 6.12077540207146, 
			6.11999890417044, 6.11922240626943, 6.11857706625649, 6.11852922328927, 
			6.11848138032205, 6.11843353735482, 6.1183856943876, 6.11833785142038, 
			6.11809589398192, 6.1178458484405, 6.11759580289908, 6.11734575735765, 
			6.11709571181623, 6.11619624567227, 6.11506860472202, 6.11394096377176, 
			6.11281332282151, 6.11168568187126, 6.11113460491759, 6.11111574088384, 
			6.11109687685009, 6.11107801281634, 6.11105914878259, 6.11129442504949, 
			6.11212269535126, 6.11295096565303, 6.1137792359548, 6.11460750625656, 
			6.11532525232676, 6.11477196973393, 6.11421868714109, 6.11366540454826, 
			6.11311212195542, 6.11255883936259, 6.11225137149631, 6.11198391998087, 
			6.11171646846543, 6.11144901694999, 6.11118156543455, 6.11100150862651, 
			6.11087061134137, 6.11073971405624, 6.11060881677111, 6.11047791948598, 
			6.1101215885427, 6.10945394445245, 6.10878630036219, 6.10811865627194, 
			6.10745101218169, 6.10678914430346, 6.10615038127335, 6.10551161824325, 
			6.10487285521314, 6.10423409218303, 6.10359532915293, 6.10307528651962, 
			6.10255766675156, 6.10204004698349, 6.10152242721543, 6.10100480744737, 
			6.09713571527797, 6.09220826340289, 6.08728081152782, 6.08235335965274, 
			6.07742590777766, 6.07516335689911, 6.07517090686946, 6.07517845683981, 
			6.07518600681015, 6.0751935567805, 6.0750893716905, 6.07474774959725, 
			6.07440612750401, 6.07406450541076, 6.07372288331752, 6.07340596682292, 
			6.07331140071606, 6.0732168346092, 6.07312226850235, 6.07302770239549, 
			6.07293313628863, 6.07272902978931, 6.07250998596375, 6.07229094213818, 
			6.07207189831262, 6.07185285448705, 6.07175565554056, 6.07172122516813, 
			6.0716867947957, 6.07165236442327, 6.07161793405084, 6.07161082181252, 
			6.07163847810853, 6.07166613440453, 6.07169379070054, 6.07172144699655, 
			6.07174301890744, 6.07174301890744, 6.07174301890744, 6.07174301890744, 
			6.07174301890744, 6.07174301890744)
	
	
	tsoil_C<-c(3.8638493, 3.8625959, 3.8613425, 3.860089, 3.8588356, 3.8575822, 
			3.858755, 3.8606122, 3.8624693, 3.8643264, 3.8661836, 3.8589641, 
			3.8446129, 3.8302617, 3.8159105, 3.8015593, 3.7899997, 3.783859, 
			3.7777184, 3.7715778, 3.7654371, 3.7575411, 3.7367723, 3.7160035, 
			3.6952347, 3.6744659, 3.6536971, 3.6145958, 3.5734575, 3.5323193, 
			3.491181, 3.4500428, 3.433695, 3.4290133, 3.4243316, 3.4196499, 
			3.4149682, 3.3981157, 3.3669757, 3.3358358, 3.3046958, 3.2735558, 
			3.2294947, 3.1445171, 3.0595394, 2.9745617, 2.889584, 2.8047549, 
			2.7272025, 2.6496501, 2.5720977, 2.4945454, 2.416993, 2.3852909, 
			2.3650513, 2.3448118, 2.3245722, 2.3043327, 2.2880526, 2.2746397, 
			2.2612268, 2.2478139, 2.234401, 2.214649, 2.1836275, 2.1526059, 
			2.1215844, 2.0905628, 2.0609988, 2.040388, 2.0197771, 1.9991663, 
			1.9785554, 1.9579446, 1.9626755, 1.96961, 1.9765445, 1.9834791, 
			1.9904136, 1.9695909, 1.9368724, 1.9041538, 1.8714352, 1.8387167, 
			1.7963551, 1.7435468, 1.6907386, 1.6379304, 1.5851222, 1.5391835, 
			1.5127967, 1.4864098, 1.460023, 1.4336362, 1.4075231, 1.3879816, 
			1.36844, 1.3488984, 1.3293568, 1.3098152, 1.3075895, 1.3091649, 
			1.3107402, 1.3123156, 1.3138909, 1.3047787, 1.2885415, 1.2723042, 
			1.2560669, 1.2398297, 1.2223763, 1.2029386, 1.1835009, 1.1640633, 
			1.1446256, 1.1286242, 1.1306637, 1.1327031, 1.1347425, 1.1367819, 
			1.1388213, 1.1556554, 1.1734338, 1.1912122, 1.2089905, 1.2267689, 
			1.2264973, 1.2192063, 1.2119153, 1.2046242, 1.1973332, 1.1842952, 
			1.1655102, 1.1467252, 1.1279402, 1.1091552, 1.0898752, 1.0693224, 
			1.0487697, 1.0282169, 1.0076642, 0.9879314, 0.9810445, 0.9741577, 
			0.9672709, 0.960384, 0.9534972, 0.9471851, 0.9409825, 0.9347798, 
			0.9285772, 0.9223745, 0.9197082, 0.9192093, 0.9187105, 0.9182116, 
			0.9177127, 0.9178962, 0.9191034, 0.9203105, 0.9215176, 0.9227248, 
			0.9237736, 0.9241014, 0.9244292, 0.9247571, 0.9250849, 0.9254127, 
			0.9245775, 0.9236938, 0.9228101, 0.9219265, 0.9210428, 0.9205719, 
			0.9202459, 0.91992, 0.9195941, 0.9192682, 0.917935, 0.915672, 
			0.913409, 0.9111461, 0.9088831, 0.9065876, 0.9042159, 0.9018443, 
			0.8994726, 0.897101, 0.895035, 0.896485, 0.8979349, 0.8993848, 
			0.9008347, 0.9022846, 0.8978793, 0.8925208, 0.8871624, 0.8818039, 
			0.8764454, 0.8747837, 0.8752013, 0.875619, 0.8760366, 0.8764542, 
			0.8764967, 0.8760212, 0.8755456, 0.87507, 0.8745944, 0.8741725, 
			0.8739652, 0.8737579, 0.8735506, 0.8733434, 0.8731361, 0.8730361, 
			0.8729384, 0.8728406, 0.8727429, 0.8726452, 0.8672434, 0.8601668, 
			0.8530901, 0.8460135, 0.8389368, 0.838973, 0.8450682, 0.8511635, 
			0.8572587, 0.863354, 0.8678078, 0.8687736, 0.8697393, 0.8707051, 
			0.8716709, 0.8725029, 0.8721312, 0.8717595, 0.8713879, 0.8710162, 
			0.8706445, 0.8707689, 0.870961, 0.871153, 0.8713451, 0.8715372, 
			0.8714986, 0.8713412, 0.8711839, 0.8710265, 0.8708691, 0.870781, 
			0.870781, 0.870781, 0.870781, 0.870781, 0.870781, 0.870781, 0.870781, 
			0.870781, 0.870781, 0.870781)
	
	
#soil moisture
	sm<-c(0.245654021, 0.245620584, 0.245587165, 0.245553728, 0.245520291, 
			0.245486871, 0.24558203, 0.245713445, 0.24584486, 0.245976276, 
			0.246107708, 0.246320375, 0.246596904, 0.246873433, 0.247149962, 
			0.247426474, 0.247668905, 0.247845175, 0.248021429, 0.248197682, 
			0.248373935, 0.248549474, 0.248719757, 0.24889004, 0.249060323, 
			0.249230606, 0.249400889, 0.250154621, 0.250973155, 0.251791707, 
			0.252610259, 0.253428794, 0.253541063, 0.253320946, 0.25310083, 
			0.252880731, 0.252660615, 0.252639571, 0.252852203, 0.253064852, 
			0.253277484, 0.253490133, 0.254046602, 0.255691905, 0.257337189, 
			0.258982474, 0.260627776, 0.262247805, 0.262630511, 0.263013199, 
			0.263395905, 0.263778593, 0.264161281, 0.264211915, 0.26417954, 
			0.264147165, 0.264114772, 0.264082397, 0.264199157, 0.264423903, 
			0.264648649, 0.264873396, 0.265098142, 0.265374062, 0.265740963, 
			0.266107864, 0.266474765, 0.266841666, 0.267181901, 0.267358346, 
			0.26753479, 0.267711235, 0.26788768, 0.268064124, 0.268235956, 
			0.268407371, 0.268578785, 0.268750216, 0.268921631, 0.268951325, 
			0.268920273, 0.268889221, 0.268858169, 0.268827116, 0.268869691, 
			0.268992055, 0.26911442, 0.269236784, 0.269359148, 0.269499336, 
			0.269690262, 0.269881189, 0.270072115, 0.270263042, 0.27044852, 
			0.270503053, 0.270557603, 0.270612136, 0.270666687, 0.270721237, 
			0.27075302, 0.270779826, 0.270806631, 0.270833436, 0.270860241, 
			0.27091742, 0.270994842, 0.271072281, 0.271149721, 0.27122716, 
			0.271374832, 0.271637141, 0.271899449, 0.272161758, 0.272424066, 
			0.272636837, 0.272589545, 0.27254227, 0.272494978, 0.272447703, 
			0.272400411, 0.272374215, 0.27234936, 0.272324504, 0.272299648, 
			0.272274792, 0.272334582, 0.272427304, 0.272520008, 0.27261273, 
			0.272705434, 0.272793387, 0.272876552, 0.272959736, 0.273042919, 
			0.273126085, 0.273192872, 0.273217519, 0.273242183, 0.27326683, 
			0.273291477, 0.273316733, 0.273351406, 0.273386096, 0.273420768, 
			0.273455459, 0.273490149, 0.273509174, 0.273525239, 0.273541288, 
			0.273557336, 0.273573402, 0.27357455, 0.273566579, 0.273558607, 
			0.273550617, 0.273542645, 0.273537841, 0.273537789, 0.273537719, 
			0.273537667, 0.273537615, 0.273533316, 0.273509678, 0.273486041, 
			0.273462404, 0.273438766, 0.273415129, 0.273414276, 0.273414398, 
			0.273414502, 0.273414607, 0.273414711, 0.273409768, 0.273403032, 
			0.273396296, 0.27338956, 0.273382823, 0.273385138, 0.273395808, 
			0.273406496, 0.273417165, 0.273427835, 0.273437774, 0.273446025, 
			0.273454258, 0.273462508, 0.273470759, 0.273478626, 0.273482246, 
			0.27348585, 0.27348947, 0.27349309, 0.273496711, 0.273508895, 
			0.273522472, 0.273536066, 0.273549643, 0.273563219, 0.273566579, 
			0.273564177, 0.273561774, 0.273559372, 0.27355697, 0.273556796, 
			0.273559703, 0.27356261, 0.273565517, 0.273568424, 0.273572079, 
			0.273578728, 0.273585394, 0.273592044, 0.27359871, 0.273605359, 
			0.273605498, 0.273605498, 0.273605498, 0.273605498, 0.273605498, 
			0.27360435, 0.273602818, 0.273601304, 0.273599789, 0.273598275, 
			0.273566892, 0.273510079, 0.273453265, 0.273396435, 0.273339622, 
			0.273300162, 0.273297569, 0.273294975, 0.273292382, 0.273289788, 
			0.273287752, 0.27329078, 0.273293792, 0.273296803, 0.273299832, 
			0.273302843, 0.273303208, 0.273303208, 0.273303208, 0.273303208, 
			0.273303208, 0.273305541, 0.273309074, 0.273312608, 0.273316158, 
			0.273319692, 0.273324304, 0.273330309, 0.273336297, 0.273342302, 
			0.27334829, 0.273352972, 0.273352972, 0.273352972, 0.273352972, 
			0.273352972, 0.273352972)
	
#leaf litter
	lf <- c(1.454922, 1.455792, 1.456662, 1.457532, 1.458402, 1.459272, 
			1.46341, 1.46847, 1.47353, 1.478591, 1.483651, 1.496175, 1.514565, 
			1.532954, 1.551343, 1.569733, 1.592616, 1.624224, 1.655832, 1.68744, 
			1.719047, 1.752184, 1.79653, 1.840876, 1.885222, 1.929568, 1.973914, 
			1.997012, 2.017748, 2.038485, 2.059222, 2.079959, 2.093726, 2.104214, 
			2.114701, 2.125189, 2.135677, 2.137601, 2.129471, 2.121342, 2.113212, 
			2.105082, 2.100862, 2.10902, 2.117178, 2.125336, 2.133494, 2.141787, 
			2.156701, 2.171614, 2.186528, 2.201441, 2.216354, 2.237777, 2.260826, 
			2.283875, 2.306925, 2.329974, 2.348234, 2.363027, 2.377819, 2.392611, 
			2.407404, 2.431873, 2.473547, 2.515221, 2.556894, 2.598568, 2.632963, 
			2.622649, 2.612334, 2.602019, 2.591704, 2.581389, 2.595293, 2.611303, 
			2.627312, 2.643322, 2.659331, 2.66239, 2.659898, 2.657406, 2.654915, 
			2.652423, 2.662594, 2.686484, 2.710374, 2.734264, 2.758154, 2.794285, 
			2.865258, 2.936232, 3.007205, 3.078179, 3.143954, 3.084972, 3.02599, 
			2.967009, 2.908027, 2.849045, 2.832725, 2.825769, 2.818812, 2.811856, 
			2.8049, 2.807187, 2.815635, 2.824082, 2.83253, 2.840978, 2.846885, 
			2.848645, 2.850405, 2.852165, 2.853925, 2.857199, 2.868417, 2.879636, 
			2.890854, 2.902073, 2.913291, 2.93413, 2.955583, 2.977035, 2.998488, 
			3.019941, 3.05989, 3.107031, 3.154173, 3.201314, 3.248456, 3.274474, 
			3.279368, 3.284262, 3.289156, 3.294051, 3.297311, 3.296368, 3.295426, 
			3.294484, 3.293542, 3.292293, 3.286246, 3.280199, 3.274152, 3.268105, 
			3.262057, 3.268447, 3.277205, 3.285963, 3.294721, 3.30348, 3.306663, 
			3.306428, 3.306194, 3.30596, 3.305726, 3.317824, 3.348421, 3.379018, 
			3.409615, 3.440212, 3.466312, 3.471929, 3.477546, 3.483163, 3.488779, 
			3.494396, 3.4977, 3.500909, 3.504117, 3.507325, 3.510533, 3.507596, 
			3.502499, 3.497403, 3.492306, 3.48721, 3.480855, 3.473339, 3.465822, 
			3.458306, 3.45079, 3.444225, 3.439881, 3.435537, 3.431193, 3.426849, 
			3.421815, 3.408848, 3.39588, 3.382913, 3.369946, 3.356979, 3.347748, 
			3.339126, 3.330504, 3.321881, 3.313259, 3.308692, 3.306406, 3.304121, 
			3.301835, 3.299549, 3.298396, 3.298806, 3.299216, 3.299627, 3.300037, 
			3.300037, 3.298397, 3.296756, 3.295116, 3.293476, 3.291836, 3.289733, 
			3.287621, 3.285509, 3.283396, 3.281284, 3.280241, 3.279536, 3.27883, 
			3.278125, 3.277419, 3.277104, 3.277121, 3.277138, 3.277155, 3.277172, 
			3.276645, 3.274961, 3.273277, 3.271593, 3.269909, 3.267587, 3.259529, 
			3.251472, 3.243414, 3.235356, 3.227298, 3.226331, 3.226331, 3.226331, 
			3.226331, 3.226331, 3.224872, 3.222661, 3.22045, 3.218238, 3.216027, 
			3.214805, 3.214842, 3.21488, 3.214917, 3.214954, 3.214983, 3.214983, 
			3.214983, 3.214983, 3.214983, 3.214983)
#fine-root litter
#	lr <- c(14.07276, 14.0970496, 14.1213392, 14.1456288, 14.1699184, 14.194208, 
#			14.2915928, 14.4095944, 14.527596, 14.6455976, 14.7635992, 14.814, 
#			14.8112856, 17.19535, 17.20538, 17.2154, 17.2378, 17.42925, 17.6207, 
#			17.33192, 17.41926, 17.2307, 17.15038, 16.15626, 15.59326, 15.36135, 
#			15.40335, 14.76836, 13.66564, 13.8784, 13.88541, 13.8304, 13.76537, 
#			13.81032, 13.78577, 13.71636, 13.68388, 14.03271, 14.38128, 14.53836, 
#			15.16432, 15.23051, 15.32293, 15.65074, 17.06225, 18.94477, 18.65519, 
#			18.53034, 18.81793, 19.09861, 19.69394, 20.41185, 21.26211, 21.96936, 
#			22.4675, 22.96565, 23.47919, 24.02108, 22.94921, 21.17618, 20.1649, 
#			19.77452, 19.44448, 19.39502, 19.43985, 19.48469, 19.58875, 19.75028, 
#			19.73176, 19.7048, 19.67785, 19.65089, 19.44189, 18.23696, 17.03203, 
#			15.8271, 14.62218, 14.4417, 14.553, 14.66431, 14.55878, 14.3641, 
#			14.16941, 13.97473, 13.58262, 12.84911, 12.11559, 11.38208, 10.64856, 
#			10.53332, 10.52961, 10.5259, 10.52219, 10.51849, 10.51478, 10.51122, 
#			10.50793, 10.50463, 10.50134, 10.49804, 10.49475, 10.49145, 10.48815, 
#			10.48486, 10.48156, 10.47827, 10.47497, 10.47168, 10.46838, 10.46508, 
#			10.46179, 10.45849, 10.4552, 10.4519, 10.45074, 10.45244, 10.45413, 
#			10.45582, 10.45752, 10.45921, 10.46092, 10.46264, 10.46437, 10.4661, 
#			10.46782, 10.46955, 10.47127, 10.473, 10.47473, 10.47645, 10.47818, 
#			10.47987, 10.48131, 10.48274, 10.48418, 10.48561, 10.48705, 10.48848, 
#			10.48991, 10.49135, 10.49278, 10.49422, 10.49565, 10.49709, 10.49852, 
#			10.49996, 10.50139, 10.50283, 10.50426, 10.5057, 10.50713, 10.50856, 
#			10.51, 10.51143, 10.51287, 10.5143, 10.51574, 10.51717, 10.51861, 
#			10.52004, 10.52148, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291)
#	lr<-c(13.20950049, 13.21747052, 13.22544536, 13.23342501, 13.24140948, 
#			13.24939876, 13.2825354, 13.32287314, 13.36333238, 13.4039145, 
#			13.44462084, 13.48395701, 13.52223245, 13.56061553, 13.59910858, 
#			13.63770988, 13.68563963, 13.75171059, 13.81810155, 13.88481303, 
#			14.07276, 14.0970496, 14.1213392, 14.1456288, 14.1699184, 14.194208, 
#			14.2915928, 14.4095944, 14.527596, 14.6455976, 14.7635992, 14.814, 
#			14.8112856, 17.19535, 17.20538, 17.2154, 17.2378, 17.42925, 17.6207, 
#			17.33192, 17.41926, 17.2307, 17.15038, 16.15626, 15.59326, 15.36135, 
#			15.40335, 14.76836, 13.66564, 13.8784, 13.88541, 13.8304, 13.76537, 
#			13.81032, 13.78577, 13.71636, 13.68388, 14.03271, 14.38128, 14.53836, 
#			15.16432, 15.23051, 15.32293, 15.65074, 17.06225, 18.94477, 18.65519, 
#			18.53034, 18.81793, 19.09861, 19.69394, 20.41185, 21.26211, 21.96936, 
#			22.4675, 22.96565, 23.47919, 24.02108, 22.94921, 21.17618, 20.1649, 
#			19.77452, 19.44448, 19.39502, 19.43985, 19.48469, 19.58875, 19.75028, 
#			19.73176, 19.7048, 19.67785, 19.65089, 19.44189, 18.23696, 17.03203, 
#			15.8271, 14.62218, 14.4417, 14.553, 14.66431, 14.55878, 14.3641, 
#			14.16941, 13.97473, 13.58262, 12.84911, 12.11559, 11.38208, 10.64856, 
#			10.53332, 10.52961, 10.5259, 10.52219, 10.51849, 10.51478, 10.51122, 
#			10.50793, 10.50463, 10.50134, 10.49804, 10.49475, 10.49145, 10.48815, 
#			10.48486, 10.48156, 10.47827, 10.47497, 10.47168, 10.46838, 10.46508, 
#			10.46179, 10.45849, 10.4552, 10.4519, 10.45074, 10.45244, 10.45413, 
#			10.45582, 10.45752, 10.45921, 10.46092, 10.46264, 10.46437, 10.4661, 
#			10.46782, 10.46955, 10.47127, 10.473, 10.47473, 10.47645, 10.47818, 
#			10.47987, 10.48131, 10.48274, 10.48418, 10.48561, 10.48705, 10.48848, 
#			10.48991, 10.49135, 10.49278, 10.49422, 10.49565, 10.49709, 10.49852, 
#			10.49996, 10.50139, 10.50283, 10.50426, 10.5057, 10.50713, 10.50856, 
#			10.51, 10.51143, 10.51287, 10.5143, 10.51574, 10.51717, 10.51861, 
#			10.52004, 10.52148, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
#			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291)

lr<-c(13.20950049, 13.21747052, 13.22544536, 13.23342501, 13.24140948, 
			13.24939876, 13.2825354, 13.32287314, 13.36333238, 13.4039145, 
			13.44462084, 13.48395701, 13.52223245, 13.56061553, 13.59910858, 
			13.63770988, 13.68563963, 13.75171059, 13.81810155, 13.88481303, 
			14.07276, 14.0970496, 14.1213392, 14.1456288, 14.1699184, 14.194208, 
			14.2915928, 14.4095944, 14.527596, 14.6455976, 14.7635992, 14.814, 
			16.98438, 17.19535, 17.20538, 17.2154, 17.2378, 17.42925, 17.6207, 
			17.33192, 17.41926, 17.2307, 17.15038, 16.15626, 15.59326, 15.36135, 
			15.40335, 14.76836, 13.79268, 13.8784, 13.88541, 13.8304, 13.76537, 
			13.81032, 13.78577, 13.71636, 13.68388, 14.03271, 14.38128, 14.53836, 
			15.16432, 15.23051, 15.32293, 15.65074, 17.06225, 18.94477, 18.65519, 
			18.53034, 18.81793, 19.09861, 19.69394, 20.41185, 21.26211, 21.96936, 
			22.4675, 22.96565, 23.47919, 24.02108, 22.94921, 21.17618, 20.1649, 
			19.85275, 19.69001, 19.52726, 19.79473, 20.14605, 20.49738, 20.77181, 
			20.92233, 21.07285, 21.22338, 20.15633, 19.44189, 18.23696, 17.04459, 
			16.6603, 16.27601, 15.90863, 16.32476, 16.74088, 17.157, 16.83519, 
			15.9503, 15.06542, 14.26061, 14.08276, 13.90491, 13.72706, 10.64856, 
			10.53332, 10.52961, 10.5259, 10.52219, 10.51849, 10.51478, 10.51122, 
			10.50793, 10.50463, 10.50134, 10.49804, 10.49475, 10.49145, 10.48815, 
			10.48486, 10.48156, 10.47827, 10.47497, 10.47168, 10.46838, 10.46508, 
			10.46179, 10.45849, 10.4552, 10.4519, 10.45074, 10.45244, 10.45413, 
			10.45582, 10.45752, 10.45921, 10.46092, 10.46264, 10.46437, 10.4661, 
			10.46782, 10.46955, 10.47127, 10.473, 10.47473, 10.47645, 10.47818, 
			10.47987, 10.48131, 10.48274, 10.48418, 10.48561, 10.48705, 10.48848, 
			10.48991, 10.49135, 10.49278, 10.49422, 10.49565, 10.49709, 10.49852, 
			10.49996, 10.50139, 10.50283, 10.50426, 10.5057, 10.50713, 10.50856, 
			10.51, 10.51143, 10.51287, 10.5143, 10.51574, 10.51717, 10.51861, 
			10.52004, 10.52148, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 
			10.52291, 10.52291, 10.52291, 10.52291, 10.52291, 10.52291)
	
	
#RAW CWD litter
	lc<-c(3.531904, 3.552538, 3.573172, 3.593806, 3.61444, 3.635074, 
			3.655708, 3.676342, 3.696976, 3.71761, 3.738244, 3.758878, 3.779512, 
			3.800146, 3.82078, 3.841413, 3.778369, 3.704099, 3.633691, 3.582685, 
			3.525603, 3.449225, 3.53919, 3.55127, 3.542735, 3.577252, 3.676392, 
			3.45754, 3.442709, 3.618918, 3.663576, 3.700669, 3.729837, 3.603815, 
			3.434249, 3.447522, 3.556507, 3.542682, 3.431888, 3.392419, 3.407141, 
			3.412588, 3.321656, 3.214431, 3.199986, 3.184977, 3.16301, 3.1228, 
			3.179775, 3.251245, 3.313892, 3.326251, 3.463568, 3.543486, 3.465287, 
			3.38012, 3.287374, 3.235694, 3.184014, 3.169009, 3.172569, 3.095257, 
			2.954537, 2.813818, 2.853936, 2.894055, 2.934174, 2.953986, 2.966974, 
			2.974782, 2.946851, 2.918921, 2.916424, 2.919295, 2.899078, 2.847516, 
			2.795954, 2.744392, 2.69283, 2.683212, 2.6923, 2.701389, 2.710477, 
			2.674492, 2.624957, 2.575423, 2.525888, 2.476354, 2.448837, 2.42132, 
			2.393803, 2.366285, 2.338768, 2.311251, 2.283734, 2.256217, 2.2287, 
			2.201183, 2.194333, 2.192551, 2.190769, 2.188986, 2.187204, 2.185422, 
			2.18364, 2.181857, 2.180156, 2.178868, 2.17758, 2.176293, 2.175005, 
			2.173717, 2.172429, 2.171142, 2.169854, 2.168566, 2.167278, 2.165991, 
			2.164703, 2.163415, 2.152678, 2.141941, 2.131204, 2.120467, 2.10973, 
			2.098993, 2.088256, 2.077519, 2.066782, 2.056045, 2.045308, 2.034571, 
			2.023834, 2.013097, 2.00739, 2.00715, 2.00691, 2.006671, 2.006431, 
			2.006191, 2.005951, 2.005711, 2.005471, 2.005231, 2.004991, 2.004752, 
			2.004512, 2.004272, 2.004032, 2.003792, 2.003552, 2.003312, 2.003072, 
			2.002833, 2.002593, 2.002353, 2.002113, 2.001873, 2.001633, 2.001393, 
			1.99991, 1.997697, 1.995484, 1.993272, 1.991059, 1.988846, 1.986633, 
			1.98442, 1.982207, 1.979994, 1.977781, 1.975568, 1.973356, 1.971143, 
			1.96893, 1.966717, 1.964504, 1.962291, 1.960078, 1.957865, 1.955652, 
			1.95344, 1.951227, 1.949014, 1.946801, 1.944588, 1.942375, 1.940162, 
			1.937949, 1.935736, 1.933524, 1.931311, 1.929098, 1.926885, 1.924672, 
			1.922459, 1.920246, 1.918033, 1.91582, 1.913608, 1.911395, 1.909182, 
			1.906969, 1.904756, 1.902543, 1.90033, 1.898117, 1.895904, 1.893692, 
			1.891479, 1.889266, 1.887053, 1.88484, 1.882627, 1.880414, 1.878201, 
			1.875988, 1.873776, 1.871563, 1.86935, 1.867137, 1.864924, 1.862711, 
			1.860498, 1.858285, 1.856072, 1.85386, 1.851647, 1.849434, 1.847221, 
			1.845008, 1.842795, 1.840582, 1.838369, 1.836156, 1.833944, 1.831731, 
			1.829518, 1.827305, 1.825092, 1.822879, 1.820666, 1.818453, 1.81624, 
			1.814028, 1.811815, 1.809602, 1.807389, 1.805176, 1.802963, 1.80075, 
			1.798537, 1.796325, 1.794112, 1.791899, 1.789686, 1.787473, 1.78526, 
			1.783047, 1.780834, 1.778621, 1.776409)
	lc<-lc*1.2
#soil carbon stock
	soc<-c(147.7529, 147.97501, 148.19712, 148.41923, 148.64134, 148.86345, 
			149.74321, 150.80847, 151.87372, 152.93898, 154.00423, 154.23944, 
			153.82247, 153.4055, 152.98852, 152.57155, 153.20243, 155.86738, 
			158.53232, 161.19727, 163.86222, 166.2385, 166.49794, 166.75737, 
			167.0168, 167.27624, 167.53567, 169.13251, 170.87795, 172.62339, 
			174.36883, 176.11427, 178.2711, 180.62152, 182.97194, 185.32236, 
			187.67278, 188.21105, 186.622, 185.03295, 183.4439, 181.85486, 
			180.83305, 181.6075, 182.38196, 183.15641, 183.93087, 184.73171, 
			186.82549, 188.91927, 191.01305, 193.10683, 195.20061, 195.52139, 
			195.39892, 195.27645, 195.15399, 195.03152, 195.28453, 195.80943, 
			196.33434, 196.85925, 197.38415, 198.10866, 199.18801, 200.26735, 
			201.3467, 202.42604, 203.59757, 205.33538, 207.07319, 208.811, 
			210.54881, 212.28662, 212.18754, 211.92873, 211.66991, 211.4111, 
			211.15229, 214.32531, 218.96913, 223.61294, 228.25675, 232.90056, 
			234.9066, 234.05504, 233.20349, 232.35193, 231.50038, 231.22909, 
			232.60933, 233.98958, 235.36982, 236.75007, 238.03284, 236.97618, 
			235.91952, 234.86286, 233.80621, 232.74955, 233.62509, 234.92477, 
			236.22446, 237.52414, 238.82383, 240.50268, 242.43432, 244.36595, 
			246.29759, 248.22923, 249.94977, 251.32591, 252.70205, 254.07819, 
			255.45433, 256.53141, 256.03841, 255.54541, 255.05242, 254.55942, 
			254.06642, 253.71554, 253.37372, 253.03191, 252.69009, 252.34827, 
			252.68763, 253.29189, 253.89615, 254.5004, 255.10466, 255.35519, 
			255.25198, 255.14877, 255.04557, 254.94236, 254.88432, 254.94243, 
			255.00055, 255.05866, 255.11677, 255.14774, 254.75348, 254.35921, 
			253.96494, 253.57067, 253.1764, 252.45114, 251.66283, 250.87452, 
			250.08621, 249.2979, 249.02958, 249.07996, 249.13034, 249.18072, 
			249.2311, 249.26697, 249.28106, 249.29516, 249.30925, 249.32335, 
			249.34, 249.36832, 249.39663, 249.42494, 249.45326, 249.48157, 
			249.5569, 249.63419, 249.71148, 249.78877, 249.86606, 250.26412, 
			250.77488, 251.28563, 251.79639, 252.30715, 252.68794, 252.94876, 
			253.20959, 253.47041, 253.73124, 254.01544, 254.35421, 254.69297, 
			255.03174, 255.3705, 255.70645, 256.01004, 256.31363, 256.61721, 
			256.9208, 257.22439, 257.21531, 257.15534, 257.09536, 257.03539, 
			256.97542, 256.97062, 256.99687, 257.02311, 257.04936, 257.0756, 
			257.0397, 256.91797, 256.79624, 256.67451, 256.55278, 256.44418, 
			256.38808, 256.33198, 256.27588, 256.21978, 256.16368, 256.17334, 
			256.18434, 256.19534, 256.20634, 256.21734, 256.0072, 255.72722, 
			255.44724, 255.16725, 254.88727, 254.8201, 254.93421, 255.04831, 
			255.16242, 255.27653, 255.3649, 255.39857, 255.43224, 255.4659, 
			255.49957, 255.53791, 255.61825, 255.6986, 255.77894, 255.85929, 
			255.93963, 255.94769, 255.94589, 255.94409, 255.94229, 255.94049, 
			255.95302, 255.97293, 255.99284, 256.01275, 256.03266, 256.0186, 
			255.96129, 255.90398, 255.84668, 255.78937, 255.74467, 255.74467, 
			255.74467, 255.74467, 255.74467, 255.74467)
	
	
#Parameters defination & Function used
	
	#(1) DOC exported from plot
	#  															dDOC = a_doc*ln(lai)+b_doc; 
	# DOC production, absorb and leaching is the output from complex interactions among hydrology, biochemiclogical, microclimate and biological
	# Up-to-now, there is no aggrement on the formulation and few direct measurement on that, so we formulated a log response function on several reports like Yan et al.,2015, 
	# Peichl et al.,2007¡£ Close relationship exist between DOCexport and several biological variables,like DBH, above-ground biomass, biomass of fine-roots, LAI etc.
	# For simplicity and sensitive, LAI was selected to describe the dynamics of DOCexpor for the LAI bridges the hydrological, biological and biogeochemicial processes. LAI has 
	# been used as the response variable for precipation interception and indicator of canopy development during restoration, Leaf litter is one of the most important litter that
	# produce DOC.
	a_doc <- parms["a_doc"];
	b_doc <- parms["b_doc"];
	
	#(2) Leaf decomposition
	# assign C/N = 100, TN=1% according to the mean of CarbonPROJECT Data, to calculate the k of leaf litter decomp after
	# Zhang, D., Hui, D., Luo, Y., & Zhou, G. (2008). Rates of litter decomposition 
	# in terrestrial ecosystems: global patterns and controlling factors. Journal of Plant Ecology, 1(2), 85-93.

	# lf_k<-(-2.484 + 0.026*TSoil_C + 0.0287*C/N + 0.461*TN_%)
	# then the lf_k can be shorten as lf_k<-a_lf+b_lf*Tsoil_C 
#	a_lf <- parms$a_lf
#	b_lf <- parms$b_lf
	
	#(3) Fine roots decomposition
	# to calculate the k of fine-root litter decomp after "Silver, W. L., & Miya, R. K. (2001). Global patterns in root decomposition: comparisons of 
	# climate and litter quality effects. Oecologia, 129(3), 407-419."
	# lr_k <- exp(-2.1+0.07*TSoil_C)
	# lr_k <- exp(a_lr + b_lr*TSoil_C)
#	a_lr <- parms$a_lr
#	b_lr <- parms$b_lr
	
	#(4) Soil decomposition
	# to calculate the decomp of soc after Foley et al(1995)
	# Foley, J. A. (1995). An equilibrium model of the terrestrial carbon budget. Tellus B, 47(3), 310-319.
	# and  #Zhou et al.,Zhou, T., Shi, P., Hui, D., & Luo, Y. (2009).#Spatial patterns in temperature sensitivity of soil respiration in China: Estimation
	# with inverse modeling. Science in China Series C: Life Sciences, 52(10), 982-989.
	# q10b=0.54649+0.31165*log(SOC_MgC_ha+3.14537) 
	# or q10c=5.91118*exp(-tsoil$y/11.21539)+1.48429 #Kirschbaum, M. U. (1995). The temperature dependence of soil organic matter decomposition, and the effect of
	#global warming on soil organic C storage. Soil Biology and biochemistry, 27(6), 753-760.
	
	# fts2a<-exp(log(q10a)/10*(TSoil_C-Ts_opt)) Soil temperature correstion
	# fts<-0.8*exp(0.095Ts)
	
	ts_a <- parms["ts_a"]
	ts_b <- parms["ts_b"]
	# fsm<-min(c(1.0,0.25+0.75*(Soil_moisture_[0,1]/AWC)))  Soil moisture correction

	awc <- parms["awc"]

	kbase_dpm<-parms["kbase_dpm"]
	kbase_spm<-parms["kbase_spm"]
	kbase_rpm<-parms["kbase_rpm"]
	
    kbase_som1<-parms["kbase_som1"] 
	kbase_som2<-parms["kbase_som2"]
	kbase_som3<-parms["kbase_som3"]
	kbase_som4<-parms["kbase_som4"]
	
	alf_dpm2som1<-parms["alf_dpm2som1"]
	alf_spm2som2<-parms["alf_spm2som2"]
	alf_rpm2som3<-parms["alf_rpm2som3"]
	
	alf_som1to2<-parms["alf_som1to2"]
	alf_som2to3<-parms["alf_som2to3"]
	alf_som3to4<-parms["alf_som3to4"]

#Driving data tables
#	age <- 11:272; #age
	#soil temperature
		
#ii<-which(age %in% times)
#tsoil_C<-approx(times,tsoil_C[ii],11:272)
#---------------------------------------
#lc=obs$lc
#lai=obs$lai
#tsoil_C=obs$tsoil_C
#sm=obs$sm
#lf=obs$lf
#lr=obs$lr
soc=obs$soc

#to prepare the lcf
x=1:round(parms["turnover.cwd"])
yl<-length(x)
xl=length(lc)

matrix(0,ncol=(length(lc)+yl-1),nrow=length(lc))->deco_lc
for (i in 1:xl){
	k=(i-1)+x	
#	deco_fr[i,k]<-0.3*lr$y[i]*exp(-1*lr_k[i]*x)
	deco_lc[i,k]<-lc[i]/yl
}

lcf<-apply(deco_lc,2,sum)[1:xl]
# to calculate the influence of tsoil and soil moisture
fts<-parms["ts_a"]*exp(parms["ts_b"]*tsoil_C)
fsm<-apply(cbind(rep(1.0,xl),0.25+0.75*sm/awc),1,min)
#fsm[]<-1
fts<-apply(cbind(fts,matrix(1,ncol=1,nrow=length(fts))),1,min)
ef<-fts*fsm
#to part the leaf, root and cwd into dpm, spm and rpm pools
#Calculation code
dpm_lf<-0.39*lf
spm_lf<-0.44*lf
rpm_lf<-0.17*lf

dpm_lr<-0.30*lr
spm_lr<-0.45*lr
rpm_lr<-0.25*lr

spm_lcf<-0.76*lcf
rpm_lcf<-0.24*lcf

som0_1<-0.1*soc[1]*1.6
som0_2<-0.2*soc[1]*1.6
som0_3<-0.3*soc[1]*1.6
som0_4<-0.3*soc[1]*1.6

dpm.leached<-a_doc*log(lf)+b_doc
#dpm.in<-dpm_lf+dpm_lr-dpm.leached
dpm.in<-dpm_lf+dpm_lr
spm.in<-spm_lf+spm_lr+spm_lcf
rpm.in<-rpm_lf+rpm_lr+rpm_lcf

dpm0<-dpm.in[1];spm0<-spm.in[1];rpm0<-rpm.in[1]

spm<-rpm<-dpm<-matrix(0,ncol=1,nrow=xl)
som1<-som2<-som3<-som4<-matrix(0,nrow=length(soc),ncol=1)


for (i in 1:xl){
	dpm[i]<-dpm0+dpm.in[i]
	dpm.out<-dpm[i]*fts[i]*kbase_dpm
	dpm[i]<-dpm[i]-dpm.out
	
	spm[i]<-spm0+spm.in[i]
	spm.out<-spm[i]*fts[i]*kbase_spm
	spm[i]<-spm[i]-spm.out
	
	rpm[i]<-rpm0+rpm.in[i]
	rpm.out<-rpm[i]*fts[i]*kbase_rpm
	rpm[i]<-rpm[i]-rpm.out
	
	dpm0<-dpm[i]
	spm0<-spm[i]
	rpm0<-rpm[i]
	
	som1[i]<-som0_1+dpm.out*alf_dpm2som1
	som1.out<-som1[i]*ef[i]*kbase_som1
	som1[i]<-som1[i]-som1.out

	som2[i]<-som0_2+som1.out*alf_som1to2+spm.out*alf_spm2som2
	som2.out<-som2[i]*ef[i]*kbase_som2
	som2[i]<-som2[i]-som2.out
	
	som3[i]<-som0_3+som2.out*alf_som2to3+rpm.out*alf_rpm2som3
	som3.out<-som3[i]*ef[i]*kbase_som3
	som3[i]<-som3[i]-som3.out
	
	som4[i]<-som0_4+som3.out*alf_som3to4
	som4.out<-som4[i]*ef[i]*kbase_som4
	som4[i]<-som4[i]-som4.out
	
#	som0_1<-som1[i]
#	som0_2<-som2[i]
#	som0_3<-som3[i]
#	som0_4<-som4[i]
}

soc<-som1+som2+som3+som4+rpm+spm+dpm-dpm.leached

return(data.frame(time=11:272,soc=soc))
#Return result
}

ssocCOST<-function(parms,obs){
	out<-ssoc(parms,obs);
#	cost_1<-modCost(model=out,parms,obs=obs);
	return(modCost(model=out,obs=obs))
}

ssocCOST1<-function(parms,obs){
	out<-ssoc(parms,obs);
#	cost_1<-modCost(model=out,parms,obs=obs);
	return(sum((obs$soc-out$soc)^2));  # residuals
}

mdMCMC<-function(ff=ssocCOST,parms,obs,niter=35000,wvar0=0.1,updatecov=100,lower,upper,burninlength=10000)
{
	Fit <- modFit(f=ff,p=parms,obs=obs,lower=lower,upper=upper,method='Pseudo');
	parms<-Fit$par
	MCMC1 <- modMCMC(f=ff, p=parms, niter=10000,obs=obs,
			wvar0=wvar0, updatecov=updatecov,lower=lower, upper=upper,burninlength=1000);
	lower=(summary(MCMC1)[5,])*0.5;
	upper=summary(MCMC1)[7,]*1.5;
	a<-cbind(lower,upper,parms)
	lower<-apply(a,1,min)
	upper<-apply(a,1,max)
	Cov0<-cov(MCMC1$pars)*2.4^2/(length(parms));
	parms=unlist(summary(MCMC1)[6,]);
	MCMC <- modMCMC(f=ff, p=parms, niter=niter,obs=obs,jump=Cov0,ntrydr = 3,
			wvar0=wvar0, updatecov=updatecov,lower=lower, upper=upper, burninlength=burninlength);
	return(MCMC);
}

soc<-c(147.7529, 147.97501, 148.19712, 148.41923, 148.64134, 148.86345, 
		149.74321, 150.80847, 151.87372, 152.93898, 154.00423, 154.23944, 
		153.82247, 153.4055, 152.98852, 152.57155, 153.20243, 155.86738, 
		158.53232, 161.19727, 163.86222, 166.2385, 166.49794, 166.75737, 
		167.0168, 167.27624, 167.53567, 169.13251, 170.87795, 172.62339, 
		174.36883, 176.11427, 178.2711, 180.62152, 182.97194, 185.32236, 
		187.67278, 188.21105, 186.622, 185.03295, 183.4439, 181.85486, 
		180.83305, 181.6075, 182.38196, 183.15641, 183.93087, 184.73171, 
		186.82549, 188.91927, 191.01305, 193.10683, 195.20061, 195.52139, 
		195.39892, 195.27645, 195.15399, 195.03152, 195.28453, 195.80943, 
		196.33434, 196.85925, 197.38415, 198.10866, 199.18801, 200.26735, 
		201.3467, 202.42604, 203.59757, 205.33538, 207.07319, 208.811, 
		210.54881, 212.28662, 212.18754, 211.92873, 211.66991, 211.4111, 
		211.15229, 214.32531, 218.96913, 223.61294, 228.25675, 232.90056, 
		234.9066, 234.05504, 233.20349, 232.35193, 231.50038, 231.22909, 
		232.60933, 233.98958, 235.36982, 236.75007, 238.03284, 236.97618, 
		235.91952, 234.86286, 233.80621, 232.74955, 233.62509, 234.92477, 
		236.22446, 237.52414, 238.82383, 240.50268, 242.43432, 244.36595, 
		246.29759, 248.22923, 249.94977, 251.32591, 252.70205, 254.07819, 
		255.45433, 256.53141, 256.03841, 255.54541, 255.05242, 254.55942, 
		254.06642, 253.71554, 253.37372, 253.03191, 252.69009, 252.34827, 
		252.68763, 253.29189, 253.89615, 254.5004, 255.10466, 255.35519, 
		255.25198, 255.14877, 255.04557, 254.94236, 254.88432, 254.94243, 
		255.00055, 255.05866, 255.11677, 255.14774, 254.75348, 254.35921, 
		253.96494, 253.57067, 253.1764, 252.45114, 251.66283, 250.87452, 
		250.08621, 249.2979, 249.02958, 249.07996, 249.13034, 249.18072, 
		249.2311, 249.26697, 249.28106, 249.29516, 249.30925, 249.32335, 
		249.34, 249.36832, 249.39663, 249.42494, 249.45326, 249.48157, 
		249.5569, 249.63419, 249.71148, 249.78877, 249.86606, 250.26412, 
		250.77488, 251.28563, 251.79639, 252.30715, 252.68794, 252.94876, 
		253.20959, 253.47041, 253.73124, 254.01544, 254.35421, 254.69297, 
		255.03174, 255.3705, 255.70645, 256.01004, 256.31363, 256.61721, 
		256.9208, 257.22439, 257.21531, 257.15534, 257.09536, 257.03539, 
		256.97542, 256.97062, 256.99687, 257.02311, 257.04936, 257.0756, 
		257.0397, 256.91797, 256.79624, 256.67451, 256.55278, 256.44418, 
		256.38808, 256.33198, 256.27588, 256.21978, 256.16368, 256.17334, 
		256.18434, 256.19534, 256.20634, 256.21734, 256.0072, 255.72722, 
		255.44724, 255.16725, 254.88727, 254.8201, 254.93421, 255.04831, 
		255.16242, 255.27653, 255.3649, 255.39857, 255.43224, 255.4659, 
		255.49957, 255.53791, 255.61825, 255.6986, 255.77894, 255.85929, 
		255.93963, 255.94769, 255.94589, 255.94409, 255.94229, 255.94049, 
		255.95302, 255.97293, 255.99284, 256.01275, 256.03266, 256.0186, 
		255.96129, 255.90398, 255.84668, 255.78937, 255.74467, 255.74467, 
		255.74467, 255.74467, 255.74467, 255.74467)
		
pars0 = c(a_doc =-0.4, 
		b_doc= 0.78, 
		ts_a = 0.8 , 
		ts_b = 0.095,
		awc =0.32,
		turnover.cwd=100,
		kbase_dpm = 0.7,
		kbase_spm= 0.07,
		kbase_rpm= 0.014,
		kbase_som1= 0.07,
		kbase_som2= 0.014,
		kbase_som3=0.0014,
		kbase_som4=0.0001,
		alf_dpm2som1=0.61,
		alf_spm2som2=0.45,
		alf_rpm2som3=0.61,
		alf_som1to2=0.72,
		alf_som2to3=0.54,
		alf_som3to4=0.45
);
#
#lower = c(a_doc =-0.5, 
#		b_doc= 0.5, 
#		ts_a = 0.6, 
#		ts_b = 0.05,
#		awc = 0.2,
#		turnover.cwd=100,
#		kbase_dpm = 0.2,
#		kbase_spm= 0.01,
#		kbase_rpm= 0.002,
#		kbase_som1= 0.01,
#		kbase_som2= 0.001,
#		kbase_som3=0.0001,
#		kbase_som4=0.00001,
#		alf_dpm2som1=0.3,
#		alf_spm2som2=0.3,
#		alf_rpm2som3=0.3,
#		alf_som1to2=0.5,
#		alf_som2to3=0.5,
#		alf_som3to4=0.4
#);
#
#upper = c(a_doc =-0., 
#		b_doc= 1.0, 
#		ts_a = 1 , 
#		ts_b = 0.2,
#		awc = 0.5,
#		turnover.cwd=1000,
#		kbase_dpm = 1,
#		kbase_spm= 0.15,
#		kbase_rpm= 0.03,
#		kbase_som1= 0.2,
#		kbase_som2= 0.05,
#		kbase_som3=0.002,
#		kbase_som4=0.0002,
#		alf_dpm2som1=0.7,
#		alf_spm2som2=0.7,
#		alf_rpm2som3=0.85,
#		alf_som1to2=0.9,
#		alf_som2to3=0.8,
#		alf_som3to4=0.7
#);


lower = c(a_doc =-1, 
		b_doc= 0.5, 
		ts_a = 0.6, 
		ts_b = 0.05,
		awc = 0.2,
		turnover.cwd=50,
		kbase_dpm = 0.2,
		kbase_spm= 0.01,
		kbase_rpm= 0.002,
		kbase_som1= 0.01,
		kbase_som2= 0.001,
		kbase_som3=0.0001,
		kbase_som4=0.00001,
		alf_dpm2som1=0.3,
		alf_spm2som2=0.3,
		alf_rpm2som3=0.3,
		alf_som1to2=0.5,
		alf_som2to3=0.5,
		alf_som3to4=0.4
);

upper = c(a_doc =-0., 
		b_doc= 2.0, 
		ts_a = 1 , 
		ts_b = 0.2,
		awc = 0.5,
		turnover.cwd=1000,
		kbase_dpm = 1,
		kbase_spm= 1,
		kbase_rpm= 1,
		kbase_som1= 1,
		kbase_som2= 1,
		kbase_som3=1,
		kbase_som4=1,
		alf_dpm2som1=0.7,
		alf_spm2som2=0.7,
		alf_rpm2som3=0.85,
		alf_som1to2=0.9,
		alf_som2to3=0.8,
		alf_som3to4=0.7
);

times<-11:272

obs<-data.frame(time=times,soc=soc)	

mcfit<-modFit(f=ssocCOST,p=pars0,obs=obs,lower=lower,upper=upper,method="Pseudo")
plot(ssoc(coef(mcfit),obs))
points(obs,col=2)


mcfit<-modFit(f=ssocCOST,p=coef(mcfit),obs=obs,lower=lower,upper=upper,method="SANN")
MCMC<-mdMCMC(ff=ssocCOST,parms=coef(mcfit),obs=obs,niter=50000,wvar0=0.1,updatecov=100,lower=lower,upper=upper,burninlength=1000);

mcfit<-modFit(f=ssocCOST,p=pars0,obs=obs,lower=lower,upper=upper,method="SANN")
MCMC<-modMCMC(f=ssocCOST,p=coef(mcfit),obs=obs,niter=150000,wvar0=0.1,updatecov=100,lower=lower,upper=upper,burninlength=5000,ntrydr = 3);
print(summary(MCMC))
### MCMC best parameters
#------------------------------------------------------------------------------
print(MCMC$bestpar)
##mcfit<-modFit(f=ssocCOST,p=pars0,obs=obs, method="Pseudo",lower=lower,upper=upper)

PARAMETERS = c("a_doc","b_doc","ts_a","ts_b","awc","turnover.cwd","kbase_dpm","kbase_spm","kbase_rpm","kbase_som1","kbase_som2","kbase_som3","kbase_som4","alf_dpm2som1",
		"alf_spm2som2","alf_rpm2som3","alf_som1to2","alf_som2to3","alf_som3to4");
NUMSAMPLES=10000
PMIN<-lower
PMAX<-upper
ALGORITHM <-'normal'
parms<-parms_gen_lhs(PARAMETERS, NUMSAMPLES, PMIN, PMAX, ALGORITHM) 

rst<-data.frame(parms,rss=matrix(NA,ncol=1,nrow=nrow(parms)))
for (i in 1:nrow(parms)){
	rst[i,20]<-ssocCOST1(parms[i,1:19],obs)
}

ii<-which(rst[,20]<quantile(rst[,20],0.001))
summary(rst[ii,])
#
#require(randomForestSRC)
#gf<-rfsrc(rss~.,data=rst[,c(1:16,20)],importance="permute.ensemble",nTree=200, seed=-111)
#gfp<-plot.variable(gf,partial=T)


